# 検索アルゴリズム (Search Algorithm)

SkillHub MCPにおけるスキル検索のロジックと仕様について記述します。

## 概要

v0.0.0では、**Full-Text Search (FTS)** をベースにした検索システムを採用しています。
外部API（OpenAIなど）に依存せず、ローカル環境で高速かつ軽量に動作することを重視しています。

## インデックス構成

LanceDBのFTS機能（内部エンジン: Tantivy）を使用し、以下のフィールドをインデックス化します。

*   **name**: スキル名（重要度: 高）
*   **description**: スキルの説明（重要度: 中）
*   **tags**: タグ（重要度: 中）※内部ではリストを空白区切り文字列に変換してFTSに登録（正規化: trim+小文字化）
*   **category**: カテゴリ（重要度: 中、正規化: trim+小文字化）
*   **category**: カテゴリ（重要度: 低〜中）

## 検索プロセス

検索は以下のステップで実行されます。

### 1. プリフィルタリング (Pre-filtering)
検索クエリを実行する前に、サーバー設定（`config.py`）に基づいて検索対象を絞り込みます。
これにより、無効化されているスキルが検索結果に混入することを防ぎます。

*   `skillhub_enabled_skills` または `skillhub_enabled_categories` が設定されている場合、DBクエリの `where` 句で対象を限定します。

### 2. スコアリング (Scoring)
Tantivyの標準的なスコアリングアルゴリズム（**BM25**）を使用します。
クエリに含まれるキーワードがフィールド内にどの程度出現するか、フィールドの長さなどを考慮してスコアが算出されます。

### 3. 動的フィルタリング (Dynamic Filtering)
検索結果の関連性を高めるため、**Max-Ratio Normalization** を用いた動的な足切りを行います。

#### ロジック詳細
1.  検索結果の上位 `limit` 件（デフォルト: 10件程度）を取得します。
2.  **1位のスコア ($S_{top}$)** を基準とします。
3.  各候補のスコア ($S_{i}$) に対して、相対スコア ($R_{i}$) を計算します。
    $$ R_{i} = \frac{S_{i}}{S_{top}} $$
4.  **閾値 (Threshold)** を適用します。
    *   デフォルト閾値: **0.3 (30%)**
    *   $R_{i} < 0.3$ の候補は検索結果から除外します。

#### ヒューリスティック (特例処理)
データセットが小さい場合や、ヒット数が少ない場合の「検索結果ゼロ」を防ぐため、以下の特例を設けます。

*   **ヒット数が少ない場合**: 検索ヒット数が **5件以下** の場合は、閾値フィルタリングをスキップし、すべての結果を返します。

## 設定パラメータ

| パラメータ | デフォルト値 | 説明 |
| :--- | :--- | :--- |
| `search_limit` | 10 | 検索結果の最大取得件数 |
| `search_threshold` | 0.3 | 動的フィルタリングの閾値係数 (0.0〜1.0) |

## 今後の拡張性

*   **Vector検索の導入**: 将来的に意味検索が必要になった場合、ハイブリッド検索への移行が可能です。
*   **RRF (Reciprocal Rank Fusion)**: FTSとVector検索を併用する場合、RRFによる順位統合を検討します。
