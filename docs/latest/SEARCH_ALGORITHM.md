# 検索アルゴリズム (Search Algorithm)

SkillHub MCPにおけるスキル検索のロジックと仕様について記述します。

## 概要

v0.0.0では、**Full-Text Search (FTS)** をベースにした検索システムを採用しています。
外部API（OpenAIなど）に依存せず、ローカル環境で高速かつ軽量に動作することを重視しています。

## インデックス構成

LanceDBのFTS機能（内部エンジン: Tantivy）を使用し、以下のフィールドをインデックス化します。

*   **name**: スキル名（重要度: 高）
*   **description**: スキルの説明（重要度: 中）
*   **tags**: タグ（重要度: 中）※内部ではリストを空白区切り文字列に変換してFTSに登録（正規化: trim+小文字化）
*   **category**: カテゴリ（重要度: 中、正規化: trim+小文字化）
*   **category**: カテゴリ（重要度: 低〜中）

## 検索プロセス

検索は以下のステップで実行されます。

### 1. プリフィルタリング (Pre-filtering)
検索クエリを実行する前に、サーバー設定（`config.py`）に基づいて検索対象を絞り込みます。
これにより、無効化されているスキルが検索結果に混入することを防ぎます。

*   `skillhub_enabled_skills` または `skillhub_enabled_categories` が設定されている場合、DBクエリの `where` 句で対象を限定します。

### 2. スコアリング (Scoring)
Tantivyの標準的なスコアリングアルゴリズム（**BM25**）を使用します。
クエリに含まれるキーワードがフィールド内にどの程度出現するか、フィールドの長さなどを考慮してスコアが算出されます。

### 3. 動的フィルタリング (Dynamic Filtering)
検索結果の関連性を高めるため、**Max-Ratio Normalization** を用いた動的な足切りを行います。

#### ロジック詳細
1. 検索結果を `limit` 件まで取得します（`search_limit` 設定、デフォルト 10）。
2. 先頭スコア $S_{top}$ を基準に、各候補の相対スコア $R_{i} = S_{i} / S_{top}$ を算出します。
3. 相対スコアが `search_threshold`（デフォルト 0.2）未満の候補を除外します。

> 注: 閾値スキップの特例はありません。閾値は常に適用され、値は環境変数/設定で上書きできます（`SEARCH_THRESHOLD`）。`search_limit` は取得件数の上限を指定するパラメータで、閾値とは別です。

## 設定パラメータ

| パラメータ | デフォルト値 | 説明 |
| :--- | :--- | :--- |
| `search_limit` | 10 | 検索結果の最大取得件数 |
| `search_threshold` | 0.2 | 動的フィルタリングの閾値係数 (0.0〜1.0) |

## 今後の拡張性

*   **Vector検索の導入**: 将来的に意味検索が必要になった場合、ハイブリッド検索への移行が可能です。
*   **RRF (Reciprocal Rank Fusion)**: FTSとVector検索を併用する場合、RRFによる順位統合を検討します。
